{% extends "base.html" %}

{% block head_scripts %}
<script>
    // Inyectamos la clave desde Flask como variable global
    window.CIPHER_KEY = "{{ cipher_key_js | safe }}";
</script>
{% endblock %}

{% block title %}Iniciar Sesión - CiberAttacks Study{% endblock %}

{% block content %}
<div class="form-container">
    <h2>Iniciar Sesión</h2>
    <form id="loginForm" method="POST">
        <label for="username_display">Nombre de Usuario:</label>
        <input type="hidden" id="encryptedUsername" name="username" required>
        <input type="text" id="username_display" required placeholder="Introduce tu nombre de usuario">

        <label for="password_display">Contraseña:</label>
        <input type="hidden" id="encryptedPassword" name="password" required>
        <input type="password" id="password_display" required placeholder="Introduce tu contraseña">

        <button type="submit">Iniciar Sesión</button>
    </form>
    <p><a href="{{ url_for('register') }}">¿No tienes una cuenta? Regístrate aquí</a></p>
</div>

<script>
    // Usamos la clave inyectada desde Flask
    const key = window.CIPHER_KEY;

    if (!key) {
        console.error("La clave de cifrado no está definida. El inicio de sesión no funcionará.");
        // Opcional: Deshabilitar el botón de submit o mostrar un mensaje
    }

    function encrypt(text) {
        if (!key) {
            throw new Error("Clave de cifrado no disponible.");
        }
        const f = new Fernet(key);
        const token = f.encrypt(text);
        return token;
    }

    document.getElementById('loginForm').addEventListener('submit', function(event) {
        event.preventDefault(); // Detenemos el envío normal

        const usernameInput = document.getElementById('username_display').value;
        const passwordInput = document.getElementById('password_display').value;

        try {
            // Ciframos los campos
            const encryptedUsername = encrypt(usernameInput);
            const encryptedPassword = encrypt(passwordInput);

            // Colocamos los valores cifrados en los campos ocultos
            document.getElementById('encryptedUsername').value = encryptedUsername;
            document.getElementById('encryptedPassword').value = encryptedPassword;

            // Enviamos el formulario
            this.submit();
        } catch (e) {
            console.error("Error al cifrar los datos:", e);
            alert("Hubo un error al procesar tus credenciales. Por favor, inténtalo de nuevo.");
        }
    });
</script>
{% endblock %}